version: '3.8'

services:
  # Redis - Session Store
  redis:
    image: redis:7-alpine
    container_name: bestdoctors_redis
    command: redis-server --requirepass ${REDIS_PASSWORD:-ChangeMe_Redis_Password_123}
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - bestdoctors-network
    healthcheck:
      test: [ "CMD", "redis-cli", "--raw", "incr", "ping" ]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # Database Migrator (Runs once on startup)
  migrator:
    image: alpine:3.19
    container_name: bestdoctors_migrator
    depends_on:
      - backend
    volumes:
      - ./backend/migrations:/migrations
    environment:
      - PG_HOST=${PG_HOST}
      - PG_PORT=${PG_PORT}
      - PG_USER=${PG_USER}
      - PG_PASSWORD=${PG_PASSWORD}
      - PG_DATABASE=${PG_DATABASE}
    command: >
      sh -c "apk add --no-cache postgresql-client &&
             echo 'Waiting for database...' &&
             sleep 5 &&
             echo 'Running migrations...' &&
             PGPASSWORD=$$PG_PASSWORD psql -h $$PG_HOST -p $$PG_PORT -U $$PG_USER -d $$PG_DATABASE -f /migrations/001_create_users.sql &&
             echo 'Migrations completed!'"
    networks:
      - bestdoctors-network

  # Backend Service - Go API
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: bestdoctors_backend
    depends_on:
      redis:
        condition: service_healthy
    ports:
      - "9002:9002"
    environment:
      - PORT=9002
      # SuperAdmin credentials
      - SUPERADMIN_USERNAME=${SUPERADMIN_USERNAME}
      - SUPERADMIN_PASSWORD=${SUPERADMIN_PASSWORD}
      # Redis
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
      # CORS
      - ALLOWED_ORIGIN=${ALLOWED_ORIGIN}
      # Database configuration
      - PG_HOST=${PG_HOST}
      - PG_PORT=${PG_PORT}
      - PG_USER=${PG_USER}
      - PG_PASSWORD=${PG_PASSWORD}
      - PG_DATABASE=${PG_DATABASE}
      - PG_SSLMODE=${PG_SSLMODE:-disable}
      # Optional: Supabase API
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_KEY}
      # Optional cache database
      - DB_NAME=${DB_NAME:-}
      - DB_USER=${DB_USER:-}
      - DB_PASSWORD=${DB_PASSWORD:-}
      - DB_HOST=${DB_HOST:-}
      - DB_PORT=${DB_PORT:-}
      - DB_SCHEMA=${DB_SCHEMA:-}
      # Other service configurations
      - TWILIO_URL=${TWILIO_URL:-}
      - TWILIO_ACCOUNT_SID=${TWILIO_ACCOUNT_SID:-}
      - TWILIO_AUTH_TOKEN=${TWILIO_AUTH_TOKEN:-}
    networks:
      - bestdoctors-network
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9002/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # Frontend Service - Vue 3 + Vite
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: bestdoctors_frontend
    ports:
      - "80:80"
    networks:
      - bestdoctors-network
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    restart: unless-stopped

networks:
  bestdoctors-network:
    driver: bridge
    name: bestdoctors-network

volumes:
  redis-data:
